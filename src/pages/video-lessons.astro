---
import BaseLayout from '../layouts/BaseLayout.astro';
import ContactCTA from '../components/ContactCTA.astro';
import Hero from '../components/Hero.astro';
import Grid from '../components/Grid.astro';
import { getYouTubeVideos } from '../utils/youtube.mjs';
import '../styles/video-lessons.css';
import '../styles/lite-yt-embed.css';

// Get videos from cache
const allVideos = getYouTubeVideos();

// Initial values will be handled client-side
const searchQuery = '';
const currentPage = 1;
const itemsPerPage = 12;

// Pass all videos to client-side
const serializedVideos = JSON.stringify(allVideos);
---

<BaseLayout
  title="YouTube Channel Videos | Mandolin Balaji"
  description="Watch my latest YouTube videos featuring mandolin performances"
>
  <div class="stack gap-20">
    <main class="wrapper stack gap-8">
      <Hero
        title="YouTube Channel Videos"
        align="center"
      />

      <!-- Search and Pagination Controls -->
      <div class="controls">
        <div class="search-form">
          <div class="search-wrapper">
            <input 
            type="text" 
            id="searchInput"
            value={searchQuery}
            placeholder="Search videos..."
            class="search-input"
            aria-label="Search notes"
            />
          </div>
          <div class="search-button-wrapper">
            <button id="searchButton" class="search-button" aria-label="Search">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            Search
            </button>
            <button id="clearButton" class="search-button" aria-label="Clear">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#FFF" viewBox="0 0 256 256">
              <path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path>
            </svg>
            Clear
            </button>
          </div>
        </div>	

        <p class="no-results" style="display: none;">No videos found matching your search.</p>
        <p class="results-count" style="display: none;"></p>
      </div>

      <!-- Pagination controls at the top -->
      <div class="pagination">
        <div id="paginationContainer"></div>
      </div>

      <!-- Videos grid -->
      <div id="gridContainer">
        <Grid id="videoContainer">
          <!-- Videos will be inserted here by JavaScript -->
        </Grid>
      </div>

      <!-- Pagination controls at the top -->
      <div class="pagination">
        <div id="paginationContainerBottom"></div>
      </div>
    </main>
    <ContactCTA />
  </div>
</BaseLayout>
<script is:inline src="/js/lite-yt-embed.js"></script>
<script define:vars={{ serializedVideos, itemsPerPage }}>
  // Client-side search and pagination handling
  document.addEventListener('DOMContentLoaded', () => {
    const allVideos = JSON.parse(serializedVideos);
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearButton = document.getElementById('clearButton');
    const videoContainer = document.getElementById('videoContainer');
    const paginationContainer = document.getElementById('paginationContainer');
    const paginationContainerBottom = document.getElementById('paginationContainerBottom');
    const resultsCount = document.querySelector('.results-count');
    const noResults = document.querySelector('.no-results');
    let currentPage = 1;

    // Generate pagination range
    function generatePaginationRange(current, total) {
      const maxPagesToShow = 5;
      if (total <= maxPagesToShow) {
        return Array.from({ length: total }, (_, i) => i + 1);
      }
      let start = Math.max(1, current - 2);
      let end = Math.min(total, start + maxPagesToShow - 1);
      if (end - start < maxPagesToShow - 1) {
        start = Math.max(1, end - maxPagesToShow + 1);
      }
      return Array.from({ length: end - start + 1 }, (_, i) => start + i);
    }

    // Generate pagination HTML
    function generatePaginationHTML(currentPage, totalPages) {
      const range = generatePaginationRange(currentPage, totalPages);
      let html = '<div class="pagination-controls">';
      
      // Always show Prev button, but disable if on first page
      html += `<a href="#" class="page-link ${currentPage === 1 ? 'disabled' : ''}" data-page="${currentPage - 1}" ${currentPage === 1 ? 'aria-disabled="true"' : ''}>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span>Prev</span>
      </a>`;
      
      html += '<div class="page-numbers">';
      range.forEach(page => {
        html += `<a href="#" class="page-number ${page === currentPage ? 'active' : ''}" data-page="${page}" ${page === currentPage ? 'aria-current="page"' : ''}>${page}</a>`;
      });
      html += '</div>';
      
      // Always show Next button, but disable if on last page
      html += `<a href="#" class="page-link ${currentPage === totalPages ? 'disabled' : ''}" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'aria-disabled="true"' : ''}>
        <span>Next</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </a>`;
      
      html += '</div>';
      return html;
    }

    // Update video display
    function updateDisplay(searchQuery = '') {
      const filteredVideos = searchQuery
        ? allVideos.filter(video =>
            video.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
            video.description.toLowerCase().includes(searchQuery.toLowerCase())
          )
        : allVideos;

      const totalPages = Math.ceil(filteredVideos.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedVideos = filteredVideos.slice(startIndex, endIndex);

      // Update videos
      videoContainer.innerHTML = paginatedVideos.map(video => `
        <li class="video-card">
          <div class="video-wrapper">
            <lite-youtube videoid="${video.id}" playlabel="${video.title}"></lite-youtube>
          </div>
          <div class="content">
            <h3 class="video-title">${video.title}</h3>
            <p class="video-date">
              ${new Date(video.publishDate).toLocaleDateString('en-GB', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </p>
          </div>
        </li>
      `).join('');

      // Update pagination
      if (paginationContainer) {
        const paginationHTML = generatePaginationHTML(currentPage, totalPages);
        paginationContainer.innerHTML = paginationHTML;
        attachPaginationListeners();
      }
      if (paginationContainerBottom) {
        const paginationHTML = generatePaginationHTML(currentPage, totalPages);
        paginationContainerBottom.innerHTML = paginationHTML;
        attachPaginationListeners();
      }
      // Update results count
      if (resultsCount && noResults) {
        if (filteredVideos.length === 0) {
          noResults.style.display = 'block';
          resultsCount.style.display = 'none';
        } else if (searchQuery) {
          noResults.style.display = 'none';
          resultsCount.style.display = 'block';
          resultsCount.textContent = `Found ${filteredVideos.length} video${filteredVideos.length !== 1 ? 's' : ''}`;
        } else {
          noResults.style.display = 'none';
          resultsCount.style.display = 'none';
        }
      }
    }

    // Attach pagination listeners
    function attachPaginationListeners() {
      // Remove existing listeners first to prevent duplicates
      document.querySelectorAll('.page-link, .page-number').forEach(button => {
        button.replaceWith(button.cloneNode(true));
      });
      
      // Add new listeners
      document.querySelectorAll('.page-link:not(.disabled), .page-number:not(.active)').forEach(button => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          const newPage = parseInt(button.getAttribute('data-page'));
          if (newPage !== currentPage) {
            currentPage = newPage;
            updateDisplay(searchInput.value.trim());
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      });
    }

    // Search handlers
    function handleSearch() {
      currentPage = 1; // Reset to first page
      updateDisplay(searchInput.value.trim());
    }

    searchButton?.addEventListener('click', (e) => {
      e.preventDefault();
      handleSearch();
    });

    clearButton?.addEventListener('click', (e) => {
      e.preventDefault();
      searchInput.value = '';
      handleSearch();
    });

    searchInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleSearch();
      }
    });

    // Initialize display
    updateDisplay();
  });
</script>
